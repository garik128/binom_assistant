/**
 * JavaScript –¥–ª—è AI —á–∞—Ç–∞
 */

// –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
const chatState = {
    currentChatId: null,  // ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ –∏–∑ –ë–î
    messages: [],
    chats: [],  // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤
    filteredChats: [],  // –ß–∞—Ç—ã –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏/–ø–æ–∏—Å–∫–∞
    displayedCount: 10,  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —á–∞—Ç–æ–≤
    chatsPerPage: 10,    // –ß–∞—Ç–æ–≤ –Ω–∞ –æ–¥–Ω—É "—Å—Ç—Ä–∞–Ω–∏—Ü—É"
    isTyping: false,
    abortController: null,  // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤
    templates: [],
    displayedTemplatesCount: 10,  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
    templatesPerPage: 10,         // –®–∞–±–ª–æ–Ω–æ–≤ –Ω–∞ –æ–¥–Ω—É "—Å—Ç—Ä–∞–Ω–∏—Ü—É"
    editingTemplateId: null,
    allModels: [],
    favoriteModels: [],
    currentModel: 'openai/gpt-4o-mini',
    agentCategory: '',  // '' = –æ–±—ã—á–Ω—ã–π —á–∞—Ç, –∏–ª–∏ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (critical_alerts, trend_analysis, –∏ —Ç.–¥.)
    availableCategories: {}  // –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    initChat();
});


// ========== –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î —á–∞—Ç–∞–º–∏ ==========

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
async function loadChats() {
    try {
        const response = await fetch('/api/v1/chat/list');
        if (!response.ok) throw new Error('Failed to load chats');

        const data = await response.json();
        chatState.chats = data.chats || [];

        // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        if (!chatState.currentChatId && chatState.chats.length === 0) {
            await createNewChat();
        } else if (!chatState.currentChatId && chatState.chats.length > 0) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç
            await switchToChat(chatState.chats[0].id);
        }

        renderChatsList();
    } catch (error) {
        console.error('Error loading chats:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    const showMoreBtn = document.getElementById('showMoreChatsBtn');
    if (!chatsList) return;

    chatsList.innerHTML = '';

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º filteredChats –µ—Å–ª–∏ –µ—Å—Ç—å (–ø–æ–∏—Å–∫), –∏–Ω–∞—á–µ –≤—Å–µ —á–∞—Ç—ã
    const chatsToDisplay = chatState.filteredChats.length > 0 ? chatState.filteredChats : chatState.chats;
    const displayChats = chatsToDisplay.slice(0, chatState.displayedCount);

    if (displayChats.length === 0) {
        chatsList.innerHTML = '<div class="no-chats">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
        if (showMoreBtn) showMoreBtn.style.display = 'none';
        return;
    }

    displayChats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item${chat.id === chatState.currentChatId ? ' active' : ''}`;
        chatItem.dataset.chatId = chat.id;

        chatItem.innerHTML = `
            <div class="chat-item-content" onclick="switchToChat(${chat.id})">
                <div class="chat-item-title" ondblclick="editChatTitle(${chat.id}, event)">${escapeHtml(chat.title)}</div>
                <div class="chat-item-meta">${formatChatDate(chat.updated_at)} | ${chat.message_count} —Å–æ–æ–±—â.</div>
            </div>
            <button class="chat-item-delete" onclick="deleteChat(${chat.id}, event)" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
        `;

        chatsList.appendChild(chatItem);
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ"
    if (showMoreBtn) {
        if (chatsToDisplay.length > chatState.displayedCount) {
            showMoreBtn.style.display = 'flex';
        } else {
            showMoreBtn.style.display = 'none';
        }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ"
    const deleteAllBtn = document.getElementById('deleteAllChatsBtn');
    if (deleteAllBtn) {
        if (chatState.chats.length > 0) {
            deleteAllBtn.style.display = 'flex';
        } else {
            deleteAllBtn.style.display = 'none';
        }
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ —á–∞—Ç–æ–≤
function showMoreChats() {
    chatState.displayedCount += chatState.chatsPerPage;
    renderChatsList();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ —à–∞–±–ª–æ–Ω–æ–≤
function showMoreTemplates() {
    chatState.displayedTemplatesCount += chatState.templatesPerPage;
    renderTemplates();
}

// –ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º
function searchChats(query) {
    const lowerQuery = query.toLowerCase().trim();

    if (!lowerQuery) {
        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —á–∞—Ç—ã
        chatState.filteredChats = [];
        chatState.displayedCount = chatState.chatsPerPage;
        renderChatsList();
        return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —á–∞—Ç—ã –ø–æ title
    chatState.filteredChats = chatState.chats.filter(chat =>
        chat.title.toLowerCase().includes(lowerQuery)
    );

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö
    chatState.displayedCount = chatState.chatsPerPage;
    renderChatsList();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
async function createNewChat() {
    try {
        const response = await fetch('/api/v1/chat/new', {
            method: 'POST'
        });

        if (!response.ok) throw new Error('Failed to create chat');

        const newChat = await response.json();
        chatState.chats.unshift(newChat);

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π —á–∞—Ç
        await switchToChat(newChat.id);
        renderChatsList();

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const messageInput = document.getElementById('messageInput');
        if (messageInput) messageInput.focus();

    } catch (error) {
        console.error('Error creating chat:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π —á–∞—Ç
async function switchToChat(chatId) {
    try {
        const response = await fetch(`/api/v1/chat/${chatId}`);
        if (!response.ok) throw new Error('Failed to load chat');

        const chatData = await response.json();
        chatState.currentChatId = chatId;

        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö
        chatState.messages = [];

        // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';

            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            if (!chatData.messages || chatData.messages.length === 0) {
                showWelcomeMessage();
            } else {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –ë–î
                // addMessage —Å–∞–º –¥–æ–±–∞–≤–∏—Ç –≤ chatState.messages –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                chatData.messages.forEach(msg => {
                    addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false);
                });
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ
        renderChatsList();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        updateControlsState();

    } catch (error) {
        console.error('Error switching chat:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–∞');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
function showWelcomeMessage() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
    let agentName = '–û–±—ã—á–Ω—ã–π —á–∞—Ç';
    let agentDescription = '–û–±—â–µ–Ω–∏–µ —Å AI –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏';
    let agentIcon = 'üí¨';

    if (chatState.agentCategory && chatState.agentCategory !== '') {
        const category = chatState.availableCategories[chatState.agentCategory];
        if (category) {
            agentName = category.name;
            agentDescription = category.description;
            agentIcon = category.icon || 'ü§ñ';
        }
    }

    const welcomeHTML = `
        <div class="welcome-message">
            <div class="welcome-icon" style="font-size: 3rem;">${agentIcon}</div>
            <h2>–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: ${agentName}</h2>
            <p>${agentDescription}</p>
            <p style="margin-top: 1rem; color: var(--text-muted);">–ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É...</p>
        </div>
    `;

    chatMessages.innerHTML = welcomeHTML;
}

// –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
async function deleteChat(chatId, event) {
    if (event) event.stopPropagation();

    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;

    try {
        const response = await fetch(`/api/v1/chat/${chatId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete chat');

        // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞
        chatState.chats = chatState.chats.filter(c => c.id !== chatId);

        // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç
        if (chatState.currentChatId === chatId) {
            if (chatState.chats.length > 0) {
                await switchToChat(chatState.chats[0].id);
            } else {
                await createNewChat();
            }
        }

        renderChatsList();

    } catch (error) {
        console.error('Error deleting chat:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Ç–æ–≤
async function deleteAllChats() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')) return;

    try {
        const response = await fetch('/api/v1/chat/all', {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete all chats');

        const data = await response.json();

        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        chatState.chats = [];
        chatState.filteredChats = [];
        chatState.displayedCount = chatState.chatsPerPage;

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
        await createNewChat();

        renderChatsList();

        console.log(`Deleted ${data.total_deleted} chats`);

    } catch (error) {
        console.error('Error deleting all chats:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö —á–∞—Ç–æ–≤');
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î
async function saveMessagesToDB(messages) {
    if (!chatState.currentChatId) return;

    try {
        const response = await fetch(`/api/v1/chat/${chatState.currentChatId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(messages)
        });

        if (!response.ok) throw new Error('Failed to save messages');

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        await loadChats();

    } catch (error) {
        console.error('Error saving messages:', error);
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ title —á–∞—Ç–∞
async function editChatTitle(chatId, event) {
    if (event) event.stopPropagation();
    const chat = chatState.chats.find(c => c.id === chatId);
    if (!chat) return;

    const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', chat.title);
    if (!newTitle || newTitle === chat.title) return;

    try {
        const response = await fetch(`/api/v1/chat/${chatId}/title?title=${encodeURIComponent(newTitle)}`, {
            method: 'PUT'
        });

        if (!response.ok) throw new Error('Failed to update title');

        const updated = await response.json();
        const chatIndex = chatState.chats.findIndex(c => c.id === chatId);
        if (chatIndex !== -1) {
            chatState.chats[chatIndex] = updated;
        }

        renderChatsList();

    } catch (error) {
        console.error('Error updating chat title:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatChatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (days === 1) return '–í—á–µ—Ä–∞';
    if (days < 7) return `${days} –¥–Ω. –Ω–∞–∑–∞–¥`;

    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
async function initChat() {
    // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
    const chatSidebar = document.getElementById('chatSidebar');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –∏–∑ localStorage
    const savedSidebarState = localStorage.getItem('sidebarCompact');
    if (savedSidebarState === 'true') {
        chatSidebar.classList.add('compact');
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    function saveSidebarState() {
        const isCompact = chatSidebar.classList.contains('compact');
        localStorage.setItem('sidebarCompact', isCompact.toString());
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ toggle - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            chatSidebar.classList.toggle('compact');
            saveSidebarState();
        });
    }

    if (sidebarToggleMobile) {
        sidebarToggleMobile.addEventListener('click', () => {
            chatSidebar.classList.toggle('compact');
            saveSidebarState();
        });
    }

    // –ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º —Å–µ–∫—Ü–∏–π (templates, history) —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π–¥–±–∞—Ä
    const sectionHeaders = document.querySelectorAll('.section-header[data-section]');
    sectionHeaders.forEach(header => {
        header.addEventListener('click', (e) => {
            // –ï—Å–ª–∏ —Å–∞–π–¥–±–∞—Ä –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ - —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            if (chatSidebar.classList.contains('compact')) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
                if (!e.target.closest('.btn-add-template')) {
                    chatSidebar.classList.remove('compact');
                    saveSidebarState();
                }
            }
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    if (window.innerWidth <= 768) {
        document.addEventListener('click', (e) => {
            if (!chatSidebar.contains(e.target) &&
                !sidebarToggleMobile.contains(e.target) &&
                !chatSidebar.classList.contains('compact')) {
                chatSidebar.classList.add('compact');
                saveSidebarState();
            }
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    if (sendBtn) {
        sendBtn.addEventListener('click', () => {
            sendMessage();
        });
    }

    if (chatInput) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // –ù–æ–≤—ã–π —á–∞—Ç
    const newChatBtn = document.getElementById('newChatBtn');
    if (newChatBtn) {
        newChatBtn.addEventListener('click', () => {
            startNewChat();
        });
    }

    // –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤
    const examplePrompts = document.querySelectorAll('.example-prompt');
    examplePrompts.forEach(prompt => {
        prompt.addEventListener('click', () => {
            const promptText = prompt.getAttribute('data-prompt');
            chatInput.value = promptText;
            sendMessage();
        });
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
        item.addEventListener('click', (e) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
            if (e.target.closest('.chat-item-delete')) {
                return;
            }

            const chatId = item.getAttribute('data-chat-id');
            switchChat(chatId);
        });
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤
    const deleteButtons = document.querySelectorAll('.chat-item-delete');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chatItem = btn.closest('.chat-item');
            const chatId = chatItem.getAttribute('data-chat-id');
            deleteChat(chatId);
        });
    });

    // –ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º
    const chatSearchInput = document.getElementById('chatSearchInput');
    if (chatSearchInput) {
        chatSearchInput.addEventListener('input', (e) => {
            searchChats(e.target.value);
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ"
    const showMoreChatsBtn = document.getElementById('showMoreChatsBtn');
    if (showMoreChatsBtn) {
        showMoreChatsBtn.addEventListener('click', showMoreChats);
    }

    // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ"
    const deleteAllChatsBtn = document.getElementById('deleteAllChatsBtn');
    if (deleteAllChatsBtn) {
        deleteAllChatsBtn.addEventListener('click', deleteAllChats);
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    setupMessageActions();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
    initTemplates();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π
    initModelSelector();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞
    initAgentSelector();

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –∏–∑ –ë–î
    await loadChats();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
    updateControlsState();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();

    // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (chatState.isTyping) {
        stopGeneration();
        return;
    }

    if (!message) {
        return;
    }

    // –°–æ–∑–¥–∞–µ–º —á–∞—Ç, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    if (!chatState.currentChatId) {
        await createNewChat();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage('user', message);

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    chatInput.value = '';
    chatInput.style.height = 'auto';

    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const welcomeMessage = document.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
    showTypingIndicator();

    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ Stop
    setSendButtonToStop();

    // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã
    chatState.abortController = new AbortController();

    try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const modelSelect = document.getElementById('modelSelect');
        const contextLimit = document.getElementById('contextLimit');
        const selectedModel = modelSelect ? modelSelect.value : 'openai/gpt-4o-mini';
        const contextMessages = contextLimit ? parseInt(contextLimit.value) : 10;
        const useModulesMode = chatState.agentCategory !== '';  // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥—É–ª–∏

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const allHistory = chatState.messages
            .slice(0, -1) // –ò—Å–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ (—Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ) —Å–æ–æ–±—â–µ–Ω–∏–µ
            .map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'assistant',
                content: msg.text
            }));

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const chatHistory = allHistory.slice(-contextMessages);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ—Ç–º–µ–Ω—ã
        const response = await fetch('/api/v1/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                chat_history: chatHistory,
                model: selectedModel,
                context_limit: contextMessages,
                use_modules: useModulesMode,
                modules_category: chatState.agentCategory || 'critical_alerts'
            }),
            signal: chatState.abortController.signal
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        hideTypingIndicator();

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setSendButtonToNormal();

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
        addMessage('ai', data.response);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–∞—Ö
        updateTokenInfo(data.usage);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
        if (chatState.currentChatId) {
            await saveMessagesToDB([
                {role: 'user', content: message},
                {role: 'assistant', content: data.response}
            ]);
        }

        // –û—á–∏—â–∞–µ–º abortController
        chatState.abortController = null;

    } catch (error) {
        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        if (error.name === 'AbortError') {
            console.log('–ó–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            return;
        }

        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        hideTypingIndicator();
        setSendButtonToNormal();
        addMessage('ai', '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        chatState.abortController = null;
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(sender, text, saveToDB = true) {
    const chatMessages = document.getElementById('chatMessages');

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    // –ê–≤–∞—Ç–∞—Ä
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';

    if (sender === 'user') {
        avatarDiv.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        `;
    } else {
        avatarDiv.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
        `;
    }

    // –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.innerHTML = formatMessageText(text);
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π markdown –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    textDiv.setAttribute('data-original-markdown', text);

    contentDiv.appendChild(textDiv);

    // –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è AI —Å–æ–æ–±—â–µ–Ω–∏–π
    if (sender === 'ai') {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        actionsDiv.innerHTML = `
            <button class="message-action-btn" onclick="copyMessage(this)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        `;
        contentDiv.appendChild(actionsDiv);
    }

    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);

    chatMessages.appendChild(messageDiv);

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    scrollToBottom();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    chatState.messages.push({
        sender,
        text,
        timestamp: new Date()
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ (–±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)
    updateControlsState();
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–ª–Ω–æ–≥–æ markdown
function formatMessageText(text) {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ marked –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {
                    console.error('Highlight error:', err);
                }
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
        tables: true,
        headerIds: true,
        mangle: false,
        pedantic: false
    });

    // –ü–∞—Ä—Å–∏–º markdown
    return marked.parse(text);
}

// –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message';
    typingDiv.id = 'typingIndicator';

    typingDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
        </div>
        <div class="message-content">
            <div class="typing-indicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
        </div>
    `;

    chatMessages.appendChild(typingDiv);
    chatState.isTyping = true;
    scrollToBottom();
}

// –°–∫—Ä—ã—Ç–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
    chatState.isTyping = false;
}

// –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Stop
function setSendButtonToStop() {
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
        sendBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="6" width="12" height="12" rx="1"/>
            </svg>
        `;
        sendBtn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é';
        sendBtn.classList.add('stop-mode');
    }
}

// –í–µ—Ä–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
function setSendButtonToNormal() {
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
        sendBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
        `;
        sendBtn.title = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å (Enter)';
        sendBtn.classList.remove('stop-mode');
    }
}

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
function stopGeneration() {
    if (chatState.abortController) {
        chatState.abortController.abort();
        chatState.abortController = null;
    }
    hideTypingIndicator();
    setSendButtonToNormal();
    addMessage('ai', '‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.');
}

// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–∫–µ–Ω–∞—Ö
function updateTokenInfo(usage) {
    const tokenInfo = document.getElementById('tokenInfo');
    const tokenCount = document.getElementById('tokenCount');

    if (tokenInfo && tokenCount && usage) {
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã 0 (—Ä–µ–∂–∏–º –∞–≥–µ–Ω—Ç–∞) - —Å–∫—Ä—ã–≤–∞–µ–º badge
        if (usage.total_tokens === 0) {
            tokenInfo.style.display = 'none';
        } else {
            tokenCount.textContent = usage.total_tokens;
            tokenInfo.style.display = 'flex';
            tokenInfo.title = `Prompt: ${usage.prompt_tokens} | Completion: ${usage.completion_tokens} | Total: ${usage.total_tokens}`;
        }
    }
}

// –ù–æ–≤—ã–π —á–∞—Ç
// –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è startNewChat - –≤—ã–∑—ã–≤–∞–µ—Ç createNewChat –∏–∑ –ë–î
async function startNewChat() {
    await createNewChat();
}

// –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è switchChat - –≤—ã–∑—ã–≤–∞–µ—Ç switchToChat –∏–∑ –ë–î
async function switchChat(chatId) {
    await switchToChat(chatId);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞

// –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞

// –ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function copyMessage(button) {
    const messageText = button.closest('.message-content').querySelector('.message-text');
    // –ö–æ–ø–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π markdown, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç
    const markdown = messageText.getAttribute('data-original-markdown') || messageText.textContent;

    navigator.clipboard.writeText(markdown).then(() => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const originalText = button.innerHTML;
        button.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
            –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ
        `;

        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
function setupMessageActions() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ onclick –≤ HTML
}

// ============================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–ê–ë–õ–û–ù–ê–ú–ò
// ============================================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
function initTemplates() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∏–∑ LocalStorage
    loadTemplates();

    // –†–µ–Ω–¥–µ—Ä–∏–º —à–∞–±–ª–æ–Ω—ã
    renderTemplates();

    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
    const addTemplateBtn = document.getElementById('addTemplateBtn');
    if (addTemplateBtn) {
        addTemplateBtn.addEventListener('click', () => {
            openTemplateModal();
        });
    }

    // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const templateModal = document.getElementById('templateModal');
    const closeModalBtn = document.getElementById('closeTemplateModal');
    const cancelModalBtn = document.getElementById('cancelTemplateModal');
    const saveTemplateBtn = document.getElementById('saveTemplateBtn');

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeTemplateModal);
    }

    if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closeTemplateModal);
    }

    if (saveTemplateBtn) {
        saveTemplateBtn.addEventListener('click', saveTemplate);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    if (templateModal) {
        templateModal.addEventListener('click', (e) => {
            if (e.target === templateModal) {
                closeTemplateModal();
            }
        });
    }

    // –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏
    const iconOptions = document.querySelectorAll('.icon-option');
    iconOptions.forEach(icon => {
        icon.addEventListener('click', () => {
            selectTemplateIcon(icon);
        });
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ –ë–î
async function loadTemplates() {
    try {
        const response = await fetch('/api/v1/templates');
        if (!response.ok) throw new Error('Failed to load templates');

        const data = await response.json();
        chatState.templates = data.templates || [];
        renderTemplates();
    } catch (error) {
        console.error('Error loading templates:', error);
        chatState.templates = [];
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
function renderTemplates() {
    const templatesList = document.getElementById('templatesList');
    const showMoreBtn = document.getElementById('showMoreTemplatesBtn');
    if (!templatesList) return;

    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    templatesList.innerHTML = '';

    // API —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
    // –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–æ—Ä—Ç–∏—Ä—É–µ–º –µ—â—ë —Ä–∞–∑
    const sortedTemplates = [...chatState.templates].sort((a, b) => {
        return new Date(b.created_at) - new Date(a.created_at);
    });

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ N —à–∞–±–ª–æ–Ω–æ–≤
    const displayTemplates = sortedTemplates.slice(0, chatState.displayedTemplatesCount);

    if (displayTemplates.length === 0) {
        templatesList.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</div>';
        if (showMoreBtn) showMoreBtn.style.display = 'none';
        return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω
    displayTemplates.forEach(template => {
        const templateItem = createTemplateElement(template);
        templatesList.appendChild(templateItem);
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ"
    if (showMoreBtn) {
        if (sortedTemplates.length > chatState.displayedTemplatesCount) {
            showMoreBtn.style.display = 'flex';
        } else {
            showMoreBtn.style.display = 'none';
        }
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —à–∞–±–ª–æ–Ω–∞
function createTemplateElement(template) {
    const item = document.createElement('div');
    item.className = 'template-item';
    item.setAttribute('data-template-id', template.id);

    // –ò–∫–æ–Ω–∫–∞
    const iconDiv = document.createElement('div');
    iconDiv.className = 'template-icon';
    iconDiv.innerHTML = getTemplateIconSVG(template.icon);

    // –ö–æ–Ω—Ç–µ–Ω—Ç
    const contentDiv = document.createElement('div');
    contentDiv.className = 'template-content';

    const titleDiv = document.createElement('div');
    titleDiv.className = 'template-title';
    titleDiv.textContent = template.title;

    const previewDiv = document.createElement('div');
    previewDiv.className = 'template-preview';
    previewDiv.textContent = template.prompt.length > 60
        ? template.prompt.substring(0, 60) + '...'
        : template.prompt;

    contentDiv.appendChild(titleDiv);
    contentDiv.appendChild(previewDiv);

    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'template-delete';
    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
    deleteBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
    `;
    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteTemplate(template.id);
    });

    // –ö–ª–∏–∫ –ø–æ —à–∞–±–ª–æ–Ω—É - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ
    item.addEventListener('click', () => {
        useTemplate(template.id);
    });

    item.appendChild(iconDiv);
    item.appendChild(contentDiv);
    item.appendChild(deleteBtn);

    return item;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ SVG –∏–∫–æ–Ω–∫–∏ –ø–æ —Ç–∏–ø—É
function getTemplateIconSVG(iconType) {
    const icons = {
        chart: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>',
        grid: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
        alert: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
        file: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path></svg>',
        search: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>',
        settings: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>'
    };

    return icons[iconType] || icons['file'];
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openTemplateModal(templateId = null) {
    const modal = document.getElementById('templateModal');
    const modalTitle = document.getElementById('templateModalTitle');
    const templateNameInput = document.getElementById('templateName');
    const templatePromptInput = document.getElementById('templatePrompt');

    if (!modal) return;

    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω
    if (templateId) {
        const template = chatState.templates.find(t => t.id === templateId);
        if (template) {
            chatState.editingTemplateId = templateId;
            modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω';
            templateNameInput.value = template.title;
            templatePromptInput.value = template.prompt;

            // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
            const iconOption = document.querySelector(`[data-icon="${template.icon}"]`);
            if (iconOption) {
                selectTemplateIcon(iconOption);
            }
        }
    } else {
        // –ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω
        chatState.editingTemplateId = null;
        modalTitle.textContent = '–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω';
        templateNameInput.value = '';
        templatePromptInput.value = '';

        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∏–∫–æ–Ω–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const firstIcon = document.querySelector('.icon-option');
        if (firstIcon) {
            selectTemplateIcon(firstIcon);
        }
    }

    modal.style.display = 'flex';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeTemplateModal() {
    const modal = document.getElementById('templateModal');
    if (modal) {
        modal.style.display = 'none';
        chatState.editingTemplateId = null;
    }
}

// –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏
function selectTemplateIcon(iconElement) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö –∏–∫–æ–Ω–æ–∫
    document.querySelectorAll('.icon-option').forEach(icon => {
        icon.classList.remove('selected');
    });

    // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é
    iconElement.classList.add('selected');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
async function saveTemplate() {
    const templateNameInput = document.getElementById('templateName');
    const templatePromptInput = document.getElementById('templatePrompt');
    const selectedIcon = document.querySelector('.icon-option.selected');

    const name = templateNameInput.value.trim();
    const prompt = templatePromptInput.value.trim();
    const icon = selectedIcon ? selectedIcon.getAttribute('data-icon') : 'file';

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!name) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞');
        templateNameInput.focus();
        return;
    }

    if (!prompt) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞');
        templatePromptInput.focus();
        return;
    }

    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º
        if (chatState.editingTemplateId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω
            const response = await fetch(`/api/v1/templates/${chatState.editingTemplateId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: name,
                    prompt: prompt,
                    icon: icon
                })
            });

            if (!response.ok) throw new Error('Failed to update template');

            const updated = await response.json();

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            const index = chatState.templates.findIndex(t => t.id === chatState.editingTemplateId);
            if (index !== -1) {
                chatState.templates[index] = updated;
            }
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω
            const response = await fetch('/api/v1/templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: name,
                    prompt: prompt,
                    icon: icon
                })
            });

            if (!response.ok) throw new Error('Failed to create template');

            const newTemplate = await response.json();
            chatState.templates.unshift(newTemplate); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        renderTemplates();

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        closeTemplateModal();

    } catch (error) {
        console.error('Error saving template:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞');
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
async function deleteTemplate(templateId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/templates/${templateId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete template');

        // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        chatState.templates = chatState.templates.filter(t => t.id !== templateId);

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        renderTemplates();

    } catch (error) {
        console.error('Error deleting template:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞');
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
function useTemplate(templateId) {
    const template = chatState.templates.find(t => t.id === templateId);
    if (!template) return;

    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.value = template.prompt;
        chatInput.focus();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
    }

    // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
    if (window.innerWidth <= 768) {
        const chatSidebar = document.getElementById('chatSidebar');
        if (chatSidebar) {
            chatSidebar.classList.add('collapsed');
        }
    }
}

// ============================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–´–ë–û–†–û–ú –ú–û–î–ï–õ–ï–ô
// ============================================

// –¢–æ–ø–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π tools
const TOP_PROVIDERS = ['openai', 'anthropic', 'google', 'x-ai', 'deepseek'];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π
async function initModelSelector() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏–∑ localStorage
    loadFavoriteModels();

    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–µ–ª–µ–∫—Ç
    renderModelSelect();

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const selectModelBtn = document.getElementById('selectModelBtn');
    if (selectModelBtn) {
        selectModelBtn.addEventListener('click', openModelModal);
    }

    // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const closeModelModal = document.getElementById('closeModelModal');
    const closeModelModalBtn = document.getElementById('closeModelModalBtn');

    if (closeModelModal) {
        closeModelModal.addEventListener('click', closeModelModalFunc);
    }

    if (closeModelModalBtn) {
        closeModelModalBtn.addEventListener('click', closeModelModalFunc);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    const modelModal = document.getElementById('modelModal');
    if (modelModal) {
        modelModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('model-modal-overlay') || e.target === modelModal) {
                closeModelModalFunc();
            }
        });
    }

    // –ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–µ–π
    const modelSearchInput = document.getElementById('modelSearchInput');
    if (modelSearchInput) {
        modelSearchInput.addEventListener('input', (e) => {
            searchModels(e.target.value);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–∞
    const modelSelect = document.getElementById('modelSelect');
    if (modelSelect) {
        modelSelect.addEventListener('change', (e) => {
            chatState.currentModel = e.target.value;
            localStorage.setItem('selectedModel', e.target.value);
            updateModelPrice();
        });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –≤ —Ñ–æ–Ω–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
    try {
        const response = await fetch('/api/v1/chat/models');
        if (response.ok) {
            const data = await response.json();
            chatState.allModels = filterTopModels(data.models);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –∏ —Ü–µ–Ω—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π
            renderModelSelect();
            updateModelPrice();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        // –í—Å—ë —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É
        updateModelPrice();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏–∑ localStorage
function loadFavoriteModels() {
    const stored = localStorage.getItem('favoriteModels');
    const selectedModel = localStorage.getItem('selectedModel');

    if (stored) {
        try {
            chatState.favoriteModels = JSON.parse(stored);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:', e);
            chatState.favoriteModels = getDefaultFavoriteModels();
        }
    } else {
        chatState.favoriteModels = getDefaultFavoriteModels();
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    if (selectedModel && chatState.favoriteModels.find(m => m.id === selectedModel)) {
        chatState.currentModel = selectedModel;
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –≤ localStorage
function saveFavoriteModels() {
    localStorage.setItem('favoriteModels', JSON.stringify(chatState.favoriteModels));
}

// –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
function getDefaultFavoriteModels() {
    return [
        {
            id: 'openai/gpt-4o-mini',
            name: 'GPT-4o Mini',
            description: 'Fast and affordable model',
            provider: 'OpenAI'
        }
    ];
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏ –≤ —à–∞–ø–∫–µ
function updateModelPrice() {
    const modelPriceInfo = document.getElementById('modelPriceInfo');
    const modelPrice = document.getElementById('modelPrice');

    if (!modelPriceInfo || !modelPrice) return;

    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
    const currentModel = chatState.allModels.find(m => m.id === chatState.currentModel);

    if (currentModel && currentModel.pricing) {
        const priceText = formatModelPrice(currentModel.pricing);
        modelPrice.textContent = priceText;
        modelPriceInfo.style.display = 'flex';
    } else {
        modelPriceInfo.style.display = 'none';
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞
function renderModelSelect() {
    const modelSelect = document.getElementById('modelSelect');
    if (!modelSelect) return;

    // –û—á–∏—â–∞–µ–º
    modelSelect.innerHTML = '';

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
    const addedModels = new Set();
    chatState.favoriteModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        if (model.id === chatState.currentModel) {
            option.selected = true;
        }
        modelSelect.appendChild(option);
        addedModels.add(model.id);
    });

    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –Ω–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
    if (chatState.currentModel && !addedModels.has(chatState.currentModel)) {
        // –ò—â–µ–º –º–æ–¥–µ–ª—å –≤ allModels
        const currentModelData = chatState.allModels.find(m => m.id === chatState.currentModel);

        const option = document.createElement('option');
        option.value = chatState.currentModel;
        option.textContent = currentModelData ? currentModelData.name : chatState.currentModel;
        option.selected = true;
        modelSelect.appendChild(option);
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∏ –Ω–µ—Ç —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
    if (chatState.favoriteModels.length === 0 && !chatState.currentModel) {
        const option = document.createElement('option');
        option.value = 'openai/gpt-4o-mini';
        option.textContent = 'GPT-4o Mini';
        option.selected = true;
        modelSelect.appendChild(option);
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π
async function openModelModal() {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –≤ —á–∞—Ç–µ —É–∂–µ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    if (chatState.messages.length > 0) {
        alert('–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –º–æ–¥–µ–ª—å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –¥–ª—è —Å–º–µ–Ω—ã –º–æ–¥–µ–ª–∏.');
        return;
    }

    const modal = document.getElementById('modelModal');
    if (!modal) return;

    modal.classList.add('active');

    const loading = document.getElementById('modelListLoading');
    const modelList = document.getElementById('modelList');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (chatState.allModels.length === 0) {
        await loadAllModels();
    } else {
        // –ú–æ–¥–µ–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - —Å–∫—Ä—ã–≤–∞–µ–º loading –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
        if (loading) loading.style.display = 'none';
        if (modelList) modelList.style.display = 'block';
        renderModelList(chatState.allModels);
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeModelModalFunc() {
    const modal = document.getElementById('modelModal');
    if (modal) {
        modal.classList.remove('active');
    }

    // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
    const searchInput = document.getElementById('modelSearchInput');
    if (searchInput) {
        searchInput.value = '';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π –æ—Ç API
async function loadAllModels() {
    const loading = document.getElementById('modelListLoading');
    const modelList = document.getElementById('modelList');

    try {
        loading.style.display = 'flex';
        modelList.style.display = 'none';

        const response = await fetch('/api/v1/chat/models');
        if (!response.ok) {
            throw new Error('Failed to load models');
        }

        const data = await response.json();

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
        chatState.allModels = filterTopModels(data.models);

        loading.style.display = 'none';
        modelList.style.display = 'block';

        renderModelList(chatState.allModels);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        updateModelPrice();

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:', error);
        loading.innerHTML = '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π</p>';
    }
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ø–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π
function filterTopModels(models) {
    return models.filter(model => {
        const modelId = model.id.toLowerCase();
        return TOP_PROVIDERS.some(provider => modelId.startsWith(provider));
    }).sort((a, b) => {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É, –ø–æ—Ç–æ–º –ø–æ –∏–º–µ–Ω–∏
        const providerA = a.id.split('/')[0];
        const providerB = b.id.split('/')[0];
        if (providerA !== providerB) {
            return providerA.localeCompare(providerB);
        }
        return a.name.localeCompare(b.name);
    });
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
function renderModelList(models) {
    const modelList = document.getElementById('modelList');
    if (!modelList) return;

    modelList.innerHTML = '';

    if (models.length === 0) {
        modelList.innerHTML = '<p class="no-models">–ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }

    // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const favoriteIds = chatState.favoriteModels.map(m => m.id);
    const favoriteModels = models.filter(m => favoriteIds.includes(m.id));
    const otherModels = models.filter(m => !favoriteIds.includes(m.id));

    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (favoriteModels.length > 0) {
        const favoritesGroup = document.createElement('div');
        favoritesGroup.className = 'model-provider-group';

        const favoritesHeader = document.createElement('div');
        favoritesHeader.className = 'model-provider-header';
        favoritesHeader.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.003-.003.001a.752.752 0 01-.704 0l-.003-.001z"/>
            </svg>
            –ò–∑–±—Ä–∞–Ω–Ω—ã–µ
        `;
        favoritesHeader.style.borderLeftColor = '#ffc107';
        favoritesGroup.appendChild(favoritesHeader);

        favoriteModels.forEach(model => {
            const modelItem = createModelItem(model);
            favoritesGroup.appendChild(modelItem);
        });

        modelList.appendChild(favoritesGroup);
    }

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
    const groupedModels = {};
    otherModels.forEach(model => {
        const provider = model.id.split('/')[0];
        const providerName = getProviderDisplayName(provider);

        if (!groupedModels[providerName]) {
            groupedModels[providerName] = [];
        }
        groupedModels[providerName].push(model);
    });

    // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
    Object.keys(groupedModels).sort().forEach(providerName => {
        const providerGroup = document.createElement('div');
        providerGroup.className = 'model-provider-group';

        const providerHeader = document.createElement('div');
        providerHeader.className = 'model-provider-header';
        providerHeader.textContent = providerName;
        providerGroup.appendChild(providerHeader);

        groupedModels[providerName].forEach(model => {
            const modelItem = createModelItem(model);
            providerGroup.appendChild(modelItem);
        });

        modelList.appendChild(providerGroup);
    });
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –º–æ–¥–µ–ª–∏
function formatModelPrice(pricing) {
    if (!pricing || (!pricing.prompt && !pricing.completion)) {
        return 'Free';
    }

    const promptPrice = parseFloat(pricing.prompt || 0) * 1000000;
    const completionPrice = parseFloat(pricing.completion || 0) * 1000000;

    if (promptPrice === 0 && completionPrice === 0) {
        return 'Free';
    }

    return `$${promptPrice.toFixed(2)} / $${completionPrice.toFixed(2)} per 1M`;
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –º–æ–¥–µ–ª–∏
function createModelItem(model) {
    const item = document.createElement('div');
    item.className = 'model-item';

    const isFavorite = chatState.favoriteModels.some(m => m.id === model.id);
    const priceText = formatModelPrice(model.pricing);

    item.innerHTML = `
        <div class="model-item-content">
            <div class="model-item-name">${model.name}</div>
            <div class="model-item-id">${model.id}</div>
            ${model.description ? `<div class="model-item-description">${model.description.substring(0, 100)}...</div>` : ''}
            <div class="model-item-price">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                ${priceText}
            </div>
        </div>
        <button class="model-item-favorite ${isFavorite ? 'active' : ''}" data-model-id="${model.id}" title="${isFavorite ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.003-.003.001a.752.752 0 01-.704 0l-.003-.001z"/>
            </svg>
        </button>
    `;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è –≤—ã–±–æ—Ä–∞
    const modelContent = item.querySelector('.model-item-content');
    modelContent.addEventListener('click', () => {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
        chatState.currentModel = model.id;
        localStorage.setItem('selectedModel', model.id);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç
        renderModelSelect();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        updateModelPrice();

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        closeModelModalFunc();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–≤–µ–∑–¥—É
    const favoriteBtn = item.querySelector('.model-item-favorite');
    favoriteBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∫–ª–∏–∫ –Ω–∞ –º–æ–¥–µ–ª—å
        toggleFavoriteModel(model);
    });

    return item;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleFavoriteModel(model) {
    const index = chatState.favoriteModels.findIndex(m => m.id === model.id);

    if (index !== -1) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        chatState.favoriteModels.splice(index, 1);
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        const provider = model.id.split('/')[0];
        chatState.favoriteModels.push({
            id: model.id,
            name: model.name,
            description: model.description,
            provider: getProviderDisplayName(provider)
        });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º
    saveFavoriteModels();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç
    renderModelSelect();

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    const searchInput = document.getElementById('modelSearchInput');
    const searchQuery = searchInput ? searchInput.value : '';

    if (searchQuery) {
        searchModels(searchQuery);
    } else {
        renderModelList(chatState.allModels);
    }
}

// –ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–µ–π
function searchModels(query) {
    const lowerQuery = query.toLowerCase();

    const filtered = chatState.allModels.filter(model => {
        return model.id.toLowerCase().includes(lowerQuery) ||
               model.name.toLowerCase().includes(lowerQuery) ||
               (model.description && model.description.toLowerCase().includes(lowerQuery));
    });

    renderModelList(filtered);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function getProviderDisplayName(provider) {
    const providerNames = {
        'openai': 'OpenAI',
        'anthropic': 'Anthropic Claude',
        'google': 'Google Gemini',
        'x-ai': 'xAI Grok',
        'deepseek': 'DeepSeek'
    };

    return providerNames[provider] || provider.charAt(0).toUpperCase() + provider.slice(1);
}

// ========== –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±–æ—Ä–æ–º –∞–≥–µ–Ω—Ç–∞ ==========

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞
async function initAgentSelector() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ localStorage
    loadAgentCategory();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
    try {
        const response = await fetch('/api/v1/chat/agent-categories');
        if (response.ok) {
            const data = await response.json();
            chatState.availableCategories = data.categories || {};
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≥–µ–Ω—Ç–æ–≤:', error);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º label –∫–Ω–æ–ø–∫–∏ (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π!)
    updateAgentLabel();

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const selectAgentBtn = document.getElementById('selectAgentBtn');
    if (selectAgentBtn) {
        selectAgentBtn.addEventListener('click', openAgentModal);
    }

    // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const closeAgentModal = document.getElementById('closeAgentModal');
    const closeAgentModalBtn = document.getElementById('closeAgentModalBtn');

    if (closeAgentModal) {
        closeAgentModal.addEventListener('click', closeAgentModalFunc);
    }

    if (closeAgentModalBtn) {
        closeAgentModalBtn.addEventListener('click', closeAgentModalFunc);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    const agentModal = document.getElementById('agentModal');
    if (agentModal) {
        agentModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('agent-modal-overlay') || e.target === agentModal) {
                closeAgentModalFunc();
            }
        });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    try {
        const response = await fetch('/api/v1/chat/agent-categories');
        if (response.ok) {
            const data = await response.json();
            chatState.availableCategories = data.categories || {};
            renderAgentCategories();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≥–µ–Ω—Ç–æ–≤:', error);
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ ===
    const closePromptModalEl = document.getElementById('closePromptModal');
    const closePromptModalBtn = document.getElementById('closePromptModalBtn');
    const savePromptBtn = document.getElementById('savePromptBtn');
    const resetPromptBtn = document.getElementById('resetPromptBtn');
    const currentTab = document.getElementById('currentTab');
    const defaultTab = document.getElementById('defaultTab');

    if (closePromptModalEl) {
        closePromptModalEl.addEventListener('click', closePromptModal);
    }

    if (closePromptModalBtn) {
        closePromptModalBtn.addEventListener('click', closePromptModal);
    }

    if (savePromptBtn) {
        savePromptBtn.addEventListener('click', savePrompt);
    }

    if (resetPromptBtn) {
        resetPromptBtn.addEventListener('click', resetPrompt);
    }

    if (currentTab) {
        currentTab.addEventListener('click', () => switchPromptTab('current'));
    }

    if (defaultTab) {
        defaultTab.addEventListener('click', () => switchPromptTab('default'));
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    const promptModal = document.getElementById('promptModal');
    if (promptModal) {
        promptModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('prompt-modal-overlay') || e.target === promptModal) {
                closePromptModal();
            }
        });
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ localStorage
function loadAgentCategory() {
    const storedCategory = localStorage.getItem('agentCategory');
    if (storedCategory !== null) {
        chatState.agentCategory = storedCategory;
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç
        chatState.agentCategory = 'universal';
        saveAgentCategory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ localStorage
function saveAgentCategory() {
    localStorage.setItem('agentCategory', chatState.agentCategory);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ label –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞
function updateAgentLabel() {
    const label = document.getElementById('selectedAgentLabel');
    if (!label) return;

    if (chatState.agentCategory === '') {
        label.textContent = '–û–±—ã—á–Ω—ã–π —á–∞—Ç';
    } else {
        const category = chatState.availableCategories[chatState.agentCategory];
        label.textContent = category ? category.name : chatState.agentCategory;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)
function updateControlsState() {
    const hasMessages = chatState.messages.length > 0;

    // –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞
    const selectAgentBtn = document.getElementById('selectAgentBtn');
    if (selectAgentBtn) {
        if (hasMessages) {
            selectAgentBtn.disabled = true;
            selectAgentBtn.style.opacity = '0.5';
            selectAgentBtn.style.cursor = 'not-allowed';
            selectAgentBtn.title = '–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –∞–≥–µ–Ω—Ç–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞';
        } else {
            selectAgentBtn.disabled = false;
            selectAgentBtn.style.opacity = '1';
            selectAgentBtn.style.cursor = 'pointer';
            selectAgentBtn.title = '–í—ã–±—Ä–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞';
        }
    }

    // –°–µ–ª–µ–∫—Ç –º–æ–¥–µ–ª–∏
    const modelSelect = document.getElementById('modelSelect');
    if (modelSelect) {
        modelSelect.disabled = hasMessages;
        if (hasMessages) {
            modelSelect.style.opacity = '0.5';
            modelSelect.style.cursor = 'not-allowed';
        } else {
            modelSelect.style.opacity = '1';
            modelSelect.style.cursor = 'pointer';
        }
    }

    // –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
    const selectModelBtn = document.getElementById('selectModelBtn');
    if (selectModelBtn) {
        if (hasMessages) {
            selectModelBtn.disabled = true;
            selectModelBtn.style.opacity = '0.5';
            selectModelBtn.style.cursor = 'not-allowed';
            selectModelBtn.title = '–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –º–æ–¥–µ–ª—å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞';
        } else {
            selectModelBtn.disabled = false;
            selectModelBtn.style.opacity = '1';
            selectModelBtn.style.cursor = 'pointer';
            selectModelBtn.title = '–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å';
        }
    }

    // –ò–Ω–ø—É—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const contextLimit = document.getElementById('contextLimit');
    if (contextLimit) {
        contextLimit.disabled = hasMessages;
        if (hasMessages) {
            contextLimit.style.opacity = '0.5';
            contextLimit.style.cursor = 'not-allowed';
            contextLimit.title = '–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞';
        } else {
            contextLimit.style.opacity = '1';
            contextLimit.style.cursor = 'text';
            contextLimit.title = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ AI';
        }
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞
async function openAgentModal() {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –≤ —á–∞—Ç–µ —É–∂–µ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    if (chatState.messages.length > 0) {
        alert('–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –∞–≥–µ–Ω—Ç–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –¥–ª—è —Å–º–µ–Ω—ã –∞–≥–µ–Ω—Ç–∞.');
        return;
    }

    const modal = document.getElementById('agentModal');
    if (!modal) return;

    modal.classList.add('active');

    // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - –∑–∞–≥—Ä—É–∂–∞–µ–º
    if (Object.keys(chatState.availableCategories).length === 0) {
        try {
            const response = await fetch('/api/v1/chat/agent-categories');
            if (response.ok) {
                const data = await response.json();
                chatState.availableCategories = data.categories || {};
                renderAgentCategories();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≥–µ–Ω—Ç–æ–≤:', error);
        }
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeAgentModalFunc() {
    const modal = document.getElementById('agentModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≥–µ–Ω—Ç–æ–≤
function renderAgentCategories() {
    const container = document.getElementById('agentCategoriesList');
    if (!container) return;

    container.innerHTML = '';

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
    // "universal" –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤—ã–π, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    const sortedCategories = Object.entries(chatState.availableCategories)
        .sort(([keyA], [keyB]) => {
            if (keyA === 'universal') return -1;
            if (keyB === 'universal') return 1;
            return keyA.localeCompare(keyB);
        });

    sortedCategories.forEach(([categoryId, categoryInfo]) => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'agent-category';
        if (chatState.agentCategory === categoryId) {
            categoryDiv.classList.add('selected');
        }
        categoryDiv.dataset.category = categoryId;

        // –î–ª—è "universal" –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
        const showDetailsBtn = categoryId !== 'universal';

        categoryDiv.innerHTML = `
            <div class="agent-category-header">
                <div class="agent-category-icon">${categoryInfo.icon || 'ü§ñ'}</div>
                <div class="agent-category-info">
                    <h4>${categoryInfo.name}</h4>
                    <p>${categoryInfo.description}</p>
                    <span class="agent-category-modules">${categoryInfo.modules_count} ${categoryInfo.modules_count === 1 ? '–º–æ–¥—É–ª—å' : categoryInfo.modules_count < 5 ? '–º–æ–¥—É–ª—è' : '–º–æ–¥—É–ª–µ–π'}</span>
                </div>
            </div>
            <div class="agent-category-actions">
                <button class="btn-agent-select" onclick="selectAgentCategory('${categoryId}'); event.stopPropagation();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 13l4 4L19 7"/>
                    </svg>
                    –í—ã–±—Ä–∞—Ç—å
                </button>
                <button class="btn-agent-prompts" onclick="showAgentPrompts('${categoryId}'); event.stopPropagation();" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    –ü—Ä–æ–º–ø—Ç—ã
                </button>
                ${showDetailsBtn ? `<button class="btn-agent-details" onclick="showCategoryDetails('${categoryId}'); event.stopPropagation();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>` : ''}
            </div>
        `;

        container.appendChild(categoryDiv);
    });
}

// –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–≥–µ–Ω—Ç–∞
function selectAgentCategory(categoryId) {
    chatState.agentCategory = categoryId;
    saveAgentCategory();
    updateAgentLabel();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    document.querySelectorAll('.agent-category').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.category === categoryId) {
            el.classList.add('selected');
        }
    });

    // –ï—Å–ª–∏ –≤ —á–∞—Ç–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π - –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (chatState.messages.length === 0) {
        showWelcomeMessage();
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    closeAgentModalFunc();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–≥–µ–Ω—Ç–∞
async function showCategoryDetails(categoryId) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const response = await fetch(`/api/v1/chat/agent-category/${categoryId}/details`);
        if (!response.ok) {
            throw new Error('Failed to fetch category details');
        }

        const data = await response.json();
        const categoryInfo = chatState.availableCategories[categoryId];

        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
        showDetailsModal(categoryInfo, data.modules);

    } catch (error) {
        console.error('Error fetching category details:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥—É–ª—è—Ö');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏
function showDetailsModal(categoryInfo, modules) {
    // –°–æ–∑–¥–∞–µ–º overlay –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const overlay = document.createElement('div');
    overlay.className = 'details-modal-overlay';
    overlay.id = 'detailsModalOverlay';

    const modal = document.createElement('div');
    modal.className = 'details-modal';
    modal.id = 'detailsModal';

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π —Å –¥–µ—Ç–∞–ª—è–º–∏
    let modulesHTML = '';
    modules.forEach((module, index) => {
        const logicHTML = module.logic && module.logic.length > 0
            ? `<ul class="module-logic">${module.logic.map(point => `<li>${point}</li>`).join('')}</ul>`
            : '<p class="no-logic">–õ–æ–≥–∏–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</p>';

        modulesHTML += `
            <div class="module-detail ${index > 0 ? 'module-detail-separator' : ''}">
                <h4 class="module-name">${module.short_description || module.slug}</h4>
                <p class="module-description">${module.detailed_description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                <div class="module-logic-section">
                    <strong>–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:</strong>
                    ${logicHTML}
                </div>
            </div>
        `;
    });

    modal.innerHTML = `
        <div class="details-modal-header">
            <h3>${categoryInfo.icon} ${categoryInfo.name}</h3>
            <button class="details-modal-close" id="closeDetailsModal">&times;</button>
        </div>
        <div class="details-modal-body">
            <p class="category-description">${categoryInfo.description}</p>
            <div class="modules-count-badge">${categoryInfo.modules_count} ${categoryInfo.modules_count === 1 ? '–º–æ–¥—É–ª—å' : categoryInfo.modules_count < 5 ? '–º–æ–¥—É–ª—è' : '–º–æ–¥—É–ª–µ–π'}</div>
            <div class="modules-list">
                ${modulesHTML}
            </div>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    document.getElementById('closeDetailsModal').addEventListener('click', closeDetailsModal);
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeDetailsModal();
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    setTimeout(() => {
        overlay.classList.add('active');
    }, 10);
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏
function closeDetailsModal() {
    const overlay = document.getElementById('detailsModalOverlay');
    if (overlay) {
        overlay.classList.remove('active');
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}


// ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏ –∞–≥–µ–Ω—Ç–æ–≤ ==========

let currentPromptCategory = null;
let currentPromptData = null;

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–º–ø—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞
async function showAgentPrompts(categoryId) {
    try {
        currentPromptCategory = categoryId;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç–∞
        const response = await fetch(`/api/v1/chat/agent-prompts/${categoryId}`);
        if (!response.ok) {
            throw new Error('Failed to load prompt data');
        }

        currentPromptData = await response.json();

        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categoryInfo = chatState.availableCategories[categoryId];
        const categoryName = categoryInfo ? categoryInfo.name : categoryId;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('promptModalTitle').textContent = `–ü—Ä–æ–º–ø—Ç—ã: ${categoryName}`;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        document.getElementById('currentPromptTextarea').value = currentPromptData.current_prompt;
        document.getElementById('defaultPromptTextarea').value = currentPromptData.default_prompt;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
        const resetBtn = document.getElementById('resetPromptBtn');
        if (currentPromptData.is_custom) {
            resetBtn.style.display = 'inline-block';
        } else {
            resetBtn.style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updatePromptStatus();

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('promptModal');
        if (modal) {
            modal.classList.add('active');
        }

    } catch (error) {
        console.error('Error loading prompt:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–ø—Ç–∞');
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–º–ø—Ç–∞
function updatePromptStatus() {
    const statusDiv = document.getElementById('promptStatus');
    if (!statusDiv || !currentPromptData) return;

    if (currentPromptData.is_custom) {
        statusDiv.innerHTML = `
            <div class="prompt-status-custom">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É, –Ω–∞–∂–∞–≤ "–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É".</span>
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="prompt-status-default">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
                <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ—é –≤–µ—Ä—Å–∏—é.</span>
            </div>
        `;
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–º–ø—Ç–æ–≤
function closePromptModal() {
    const modal = document.getElementById('promptModal');
    if (modal) {
        modal.classList.remove('active');
    }
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –Ω–∞ "–¢–µ–∫—É—â–∏–π"
    switchPromptTab('current');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchPromptTab(tabName) {
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    document.querySelectorAll('.prompt-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.prompt-tab-content').forEach(content => content.classList.remove('active'));

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω—É–∂–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
    const tab = document.querySelector(`.prompt-tab[data-tab="${tabName}"]`);
    const content = document.getElementById(`${tabName}TabContent`);

    if (tab) tab.classList.add('active');
    if (content) content.classList.add('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç
async function savePrompt() {
    try {
        const newPrompt = document.getElementById('currentPromptTextarea').value;

        if (!newPrompt || newPrompt.trim() === '') {
            alert('–ü—Ä–æ–º–ø—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        const response = await fetch(`/api/v1/chat/agent-prompts/${currentPromptCategory}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: newPrompt })
        });

        if (!response.ok) {
            throw new Error('Failed to save prompt');
        }

        const result = await response.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        currentPromptData.current_prompt = newPrompt;
        currentPromptData.is_custom = result.is_custom;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updatePromptStatus();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
        const resetBtn = document.getElementById('resetPromptBtn');
        if (resetBtn) {
            resetBtn.style.display = 'inline-block';
        }

        alert('–ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');

    } catch (error) {
        console.error('Error saving prompt:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞');
    }
}

// –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É
async function resetPrompt() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é? –í–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/chat/agent-prompts/${currentPromptCategory}/reset`, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('Failed to reset prompt');
        }

        const result = await response.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        currentPromptData.current_prompt = currentPromptData.default_prompt;
        currentPromptData.is_custom = false;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        document.getElementById('currentPromptTextarea').value = currentPromptData.default_prompt;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updatePromptStatus();

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
        const resetBtn = document.getElementById('resetPromptBtn');
        if (resetBtn) {
            resetBtn.style.display = 'none';
        }

        alert('–ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É');

    } catch (error) {
        console.error('Error resetting prompt:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–º–ø—Ç–∞');
    }
}
