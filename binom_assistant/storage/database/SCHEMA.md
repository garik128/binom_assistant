# Схема базы данных Binom Assistant

## Обзор

База данных хранит:
- Информацию о кампаниях
- Дневную и недельную статистику
- Алерты и проблемы
- Конфигурацию и результаты модулей анализа
- Настройки приложения
- Системный кэш

## Таблицы

### campaigns

Основная таблица с кампаниями.

**Ключевые поля:**
- `internal_id` - внутренний ID (первичный ключ)
- `binom_id` - ID в Binom (уникальный)
- `current_name` - текущее имя кампании
- `is_cpl_mode` - тип кампании (CPL или CPA)
- `ts_id` - ID источника трафика (связь с traffic_sources)

**Индексы:**
- По binom_id (для быстрого поиска)
- По group_name (для группировки)
- По is_cpl_mode (для фильтрации по типу)
- По current_name (для поиска)
- По last_seen DESC (для сортировки по активности)
- По created_at DESC (для сортировки по дате создания)
- Композитный: (is_active, group_name) WHERE is_active = TRUE

### campaign_stats_daily

Дневная статистика по кампаниям.

**Особенности:**
- Одна запись = одна кампания в один день
- `snapshot_time` - когда получили данные (важно для отслеживания апрувов)
- Данные за один день могут обновляться (апрувы прилетают задним числом)

**Основные метрики:**
- clicks, leads, cost, revenue
- roi, cr, cpc, approve
- a_leads, h_leads, r_leads

**О метриках:**

**CR (Conversion Rate):**
- Коэффициент конверсии: (leads / clicks) * 100
- **Формат:** DECIMAL(10, 4) - процент от 0.00 до 100.00
- **Пример:** cr=5.5556 означает конверсию 5.56%
- **Источник:** Binom API (приходит в процентах, например "5.555555500")
- **Валидация:** 0 <= cr <= 100

**Approve:**
- Процент апрува (approval rate) - отношение одобренных лидов к общему количеству
- **Источник:** Binom API (приходит готовым значением, не вычисляется)
- **Формат:** DECIMAL(10, 2) - процент от 0.00 до 100.00
- **Пример:** approve=25.50 означает, что 25.5% лидов были одобрены
- **Важно:** Значение может обновляться задним числом при изменении статуса лидов
- **Связь с другими метриками:**
  - a_leads (approved leads) - количество одобренных лидов
  - h_leads (hold leads) - лиды на рассмотрении
  - r_leads (rejected leads) - отклоненные лиды
  - approve = (a_leads / (a_leads + h_leads + r_leads)) * 100

**Индексы:**
- По snapshot_time (для временных запросов)
- По (cost, clicks, campaign_id, date) - для фильтрации шума
- Частичный индекс WHERE cost >= 1.0 AND clicks >= 50 - для активных кампаний

### stats_weekly

Недельные агрегаты (предрасчитанные).

**Зачем:**
- Быстрый доступ к недельным данным
- Не нужно каждый раз агрегировать дни
- Основа для трендов и сравнений

**Обновление:**
- Каждый понедельник
- При изменении дневной статистики за неделю

### alerts

Обнаруженные проблемы и аномалии.

**Типы алертов:**
- `no_leads` - нет лидов N дней
- `negative_roi` - отрицательный ROI
- `cr_drop` - падение конверсии
- `high_cost` - превышение бюджета
- `anomaly` - странная активность

**Severity (важность):**
- `low` - информационно
- `medium` - стоит посмотреть
- `high` - требует внимания
- `critical` - срочно

### module_configs

Конфигурация модулей анализа.

**Назначение:**
- Хранит настройки каждого модуля
- Управление включением/выключением модулей
- Расписание автоматических запусков

**Ключевые поля:**
- `module_id` - уникальный ID модуля (PRIMARY KEY)
- `enabled` - включен ли модуль
- `schedule` - расписание в формате cron
- `alerts_enabled` - генерировать ли алерты в Telegram
- `params` - JSON с параметрами модуля

### module_runs

История запусков модулей.

**Назначение:**
- Сохраняет результаты каждого выполнения модуля
- Отслеживание ошибок и производительности

**Ключевые поля:**
- `module_id` - ссылка на module_configs
- `started_at` / `completed_at` - время выполнения
- `status` - статус (running, completed, failed)
- `results` - JSON с результатами анализа
- `params` - JSON с параметрами конкретного запуска
- `execution_time_ms` - время выполнения в миллисекундах

**Индексы:**
- По module_id
- По status
- По started_at

### module_cache

Кэш результатов модулей.

**Назначение:**
- Избежать повторных запусков с одинаковыми параметрами
- Ускорение работы API

**Ключевые поля:**
- `module_id` + `cache_key` - уникальность
- `data` - JSON с закэшированными данными
- `expires_at` - время истечения кэша

### app_settings

Настройки приложения.

**Назначение:**
- Централизованное хранение настроек
- Приоритет: БД -> .env -> defaults

**Ключевые поля:**
- `key` - уникальный ключ настройки
- `value` - значение (строка)
- `value_type` - тип (int, bool, string)
- `category` - категория (collector, schedule, data)
- `is_editable` - можно ли редактировать через UI
- `min_value` / `max_value` - ограничения для числовых значений

**Примеры настроек:**
- `collector.update_days` = 7 (период обновления статистики)
- `collector.interval_hours` = 1 (интервал сбора данных)
- `data.retention_days` = 90 (период хранения данных)
- `schedule.daily_stats` = '0 * * * *' (cron)

### name_changes

История изменений имен кампаний.

**Зачем:**
- Отслеживание переименований
- Помощь в идентификации кампаний
- Аналитика изменений

### system_cache

Системный кэш и настройки.

**Примеры ключей:**
- `last_sync_time` - время последней синхронизации
- `approval_history` - исторический % апрува
- `temp_data_*` - временные данные

## Миграции

Изменения схемы выполняются через Alembic миграции.

См. папку `storage/database/migrations/`

## Типы данных

### SQLite

Схема использует SQLite:
- `INTEGER PRIMARY KEY AUTOINCREMENT` - автоинкремент ID
- `DECIMAL(10, 2)` - эмулируется через REAL
- `VARCHAR(N)` - эмулируется через TEXT
- `BOOLEAN` - эмулируется через INTEGER (0/1)
- `TIMESTAMP` - эмулируется через TEXT (ISO8601)

### JSON поля

Поля с JSON (name_history, details, current_campaigns) хранятся как TEXT с JSON строкой.

**Пример для name_history:**
```json
[
  {
    "old_name": "Campaign 1",
    "new_name": "Campaign 1 NEW",
    "changed_at": "2025-10-23T10:00:00"
  }
]
```

**Пример для details (алерт):**
```json
{
  "days_without_leads": 5,
  "last_lead_date": "2025-10-18",
  "previous_cr": 0.025
}
```

## Индексы

Созданы индексы для:
- Поиска по ID кампаний
- Фильтрации по датам
- Группировки по категориям
- Быстрой выборки для алертов

## Каскадное удаление

При удалении кампании:
- Удаляются все связанные записи статистики
- Удаляются все алерты
- Удаляется история изменений имен

## Ограничения

- Уникальность: (campaign_id, date) в campaign_stats_daily
- Уникальность: (campaign_id, week_start) в stats_weekly
- Уникальность: (module_id, cache_key) в module_cache
- Foreign Key constraints для целостности данных
- Валидация на уровне моделей:
  - CR: 0 <= cr <= 100 (процентах)
  - ROI: roi >= -100 (процентах)
  - Approve: 0 <= approve <= 100 (процентах)
  - cost, revenue, profit >= 0

## Пример использования

### Создание базы данных

```bash
sqlite3 data/binom_assistant.db < storage/database/schema.sql
```

### Проверка таблиц

```bash
sqlite3 data/binom_assistant.db ".tables"
```

### Просмотр схемы таблицы

```bash
sqlite3 data/binom_assistant.db ".schema campaigns"
```

## Особенности реализации

### Обработка апрувов задним числом

Так как апрувы могут приходить задним числом, мы:
1. Сохраняем `snapshot_time` - когда получили данные
2. При обновлении данных за старые даты - обновляем существующую запись
3. Можем отследить изменения approve% по snapshot_time

### Фильтрация шума

Кампании с малыми показателями фильтруются на уровне запросов:
```sql
SELECT * FROM stats_daily
WHERE (cost >= 1.0 OR clicks >= 50)
```

### Агрегация недель

Недельные данные пересчитываются:
- Каждый понедельник в 3:00
- При обновлении дневных данных за период недели

```sql
INSERT INTO stats_weekly (campaign_id, week_start, total_clicks, ...)
SELECT
    campaign_id,
    DATE(date, 'weekday 0', '-6 days') as week_start,
    SUM(clicks) as total_clicks,
    ...
FROM stats_daily
WHERE date BETWEEN '2025-10-20' AND '2025-10-26'
GROUP BY campaign_id, week_start
ON CONFLICT(campaign_id, week_start)
DO UPDATE SET
    total_clicks = excluded.total_clicks,
    ...
```
